version: 2

jobs:
  build:
    docker:
      - image: quartic/uber-builder:112

    working_directory: ~/website

    steps:
      - checkout

      - restore-cache:
          keys:
            - website-v3-ssh

      - run:
          name: Register SSH key
          command: |
            if [ ! -e ~/.ssh/google_compute_engine ]; then ssh-keygen -f ~/.ssh/google_compute_engine -N ""; fi

      - save_cache:
          key: website-v3-ssh
          paths:
            - ~/.ssh

      - restore_cache:
          keys:
            - website-v3-{{ .Branch }}-yarn-{{ checksum "yarn.lock" }}
            - website-v3-{{ .Branch }}-yarn
            - website-v3-develop-yarn

      - run:
          name: Install dependencies
          command: |
            yarn install

      - save_cache:
          key: website-v3-{{ .Branch }}-yarn-{{ checksum "yarn.lock" }}
          paths:
            - node_modules

      - run:
          name: Build distribution
          command: |
            ./scripts/configure.sh
            yarn run build

      - run:
          name: Run spellchecker
          command: |
            RESULTS=$(for f in dist/*.html; do aspell list -l en_GB --add-filter=sgml --add-sgml-skip=script --add-extra-dicts=$(pwd)/wordlist < "${f}"; done)
            echo ${RESULTS}
            test "${RESULTS}" == ""

      - setup_remote_docker

      - run:
          name: Build Docker image
          command: docker build -t website .

      - run:
          name: GCloud auth
          command: |
            # TODO - move all this to helper
            echo ${GCLOUD_SERVICE_KEY_BASE64} | base64 -d > ${HOME}/gcloud-service-key.json
            gcloud auth activate-service-account --key-file ${HOME}/gcloud-service-key.json
            rm ${HOME}/gcloud-service-key.json
            docker login -u oauth2accesstoken -p "$(gcloud auth print-access-token)" https://eu.gcr.io

      - run:
          name: Publish Docker image
          command: |
            docker tag website ${GCLOUD_DOCKER_REPOSITORY}/website:${CIRCLE_BUILD_NUM}
            docker push ${GCLOUD_DOCKER_REPOSITORY}/website:${CIRCLE_BUILD_NUM}
            # Also push a latest tag to make cluster reprovisioning more pleasant
            docker tag website ${GCLOUD_DOCKER_REPOSITORY}/website:latest
            docker push ${GCLOUD_DOCKER_REPOSITORY}/website:latest

      # - deploy:
      #     command: |
      #       # See https://kubernetes.io/docs/user-guide/kubectl-cheatsheet/
      #       kubectl patch pod www -p '{"spec":{"containers":[{"name":"kubernetes-serve-hostname","image":"new image"}]}}'


      # - deploy:
      #     command: |
      #       if [ "${CIRCLE_BRANCH}" == "master" ]; then
      #         TARGET=www.quartic.io
      #       elif [ "${CIRCLE_BRANCH}" == "develop" ]; then
      #         TARGET=www-test.quartic.io
      #       else
      #         TARGET=www-dummy.quartic.io
      #       fi
      #       gcloud-auth
      #       # gcloud ssh is weird the first time the ssh key is used causing the rsync to hang
      #       # Initiate a session once first to make this regular
      #       gcloud compute ssh --zone ${GCLOUD_ZONE} ${GCLOUD_SERVICE_ACCOUNT}@${GCLOUD_WEB_INSTANCE} -- true
      #       # rsync
      #       rsync -e "gcloud compute ssh --zone ${GCLOUD_ZONE} ${GCLOUD_SERVICE_ACCOUNT}@${GCLOUD_WEB_INSTANCE} --" --delete -avz dist/ :/opt/quartic/${TARGET}